<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CalendÃ¡rio de Clientes â€” IPTV</title>

  <!-- usa o manifest que vocÃª enviou -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#667eea">

  <style>
    /* estilo baseado no seu layout â€” dark/light gradient removido para ficar parecido com seu app original.
       Mantive comportamento responsivo e modal elegante */
    :root{
      --bg:#0d1117; --card:#ffffff; --muted:#6b7280; --accent:#667eea; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{font-family: 'Segoe UI', Tahoma, Arial; margin:0; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#111; min-height:100vh; display:flex;align-items:center;justify-content:center;padding:20px}
    .container{width:100%;max-width:520px;background:#fff;border-radius:16px;padding:18px;box-shadow:0 20px 60px rgba(0,0,0,0.25)}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .header h1{font-size:20px;color:#0b1220}
    .nav-buttons{display:flex;gap:8px;margin-bottom:12px}
    .nav-buttons button{background:#667eea;color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    .month-year{text-align:center;color:#0b1220;font-weight:700;margin-bottom:12px}
    .weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:8px}
    .weekday{text-align:center;color:#666;font-weight:700;font-size:12px}
    .days{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .day{aspect-ratio:1;display:flex;align-items:flex-start;justify-content:flex-start;padding:8px;border-radius:8px;background:#f5f5f5;color:#111;position:relative;cursor:pointer}
    .day.empty{background:transparent;cursor:default;opacity:0.3}
    .day .num{font-weight:700;margin-bottom:auto}
    .day.today{outline:3px solid rgba(102,118,234,0.45);border-radius:8px}
    .badge{position:absolute;right:6px;top:6px;background:var(--accent);color:#fff;padding:4px 7px;border-radius:999px;font-size:12px}
    .dot{position:absolute;left:50%;bottom:6px;transform:translateX(-50%);width:8px;height:8px;border-radius:50%;background:var(--danger)}

    /* modal (central) */
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);backdrop-filter:blur(4px);align-items:center;justify-content:center;padding:16px;z-index:999}
    .modal{background:#fff;width:100%;max-width:420px;border-radius:12px;padding:16px;box-shadow:0 18px 50px rgba(2,6,23,0.5);color:#111;max-height:90vh;overflow:auto}
    .modal h3{margin:0 0 8px;color:var(--accent)}
    .field{margin-top:10px}
    input,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e9;font-size:14px}
    textarea{min-height:90px;resize:vertical}
    .clients-info{margin-top:10px}
    .client-row{display:flex;gap:8px;align-items:flex-start;padding:8px;border-radius:8px;background:#f5f7fb}
    .client-info{flex:1;font-size:13px;color:#222}
    .client-actions{display:flex;flex-direction:column;gap:6px}
    .btn{padding:10px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    .btn-save{background:var(--accent);color:#fff}
    .btn-close{background:#e6e6e9}
    .btn-delete{background:var(--danger);color:#fff;padding:6px 8px;border-radius:6px;font-size:13px;min-width:36px}

    /* small delete lateral style */
    .client-actions .btn-delete{transform:scale(0.9)}

    @media(max-width:480px){
      .container{padding:14px}
      .nav-buttons button{padding:8px 10px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸ“… CalendÃ¡rio de Clientes</h1>
      <button id="btnUpdate" style="background:#10b981;color:#fff;border:0;padding:8px 10px;border-radius:8px;cursor:pointer">ðŸ”„ Atualizar</button>
    </div>

    <div class="nav-buttons">
      <button id="btnPrev">â—€ Anterior</button>
      <button id="btnToday">Hoje</button>
      <button id="btnNext">PrÃ³ximo â–¶</button>
    </div>

    <div class="month-year" id="monthYear"></div>

    <div class="weekdays">
      <div class="weekday">Dom</div><div class="weekday">Seg</div><div class="weekday">Ter</div>
      <div class="weekday">Qua</div><div class="weekday">Qui</div><div class="weekday">Sex</div><div class="weekday">SÃ¡b</div>
    </div>

    <div class="days" id="calendar"></div>
  </div>

  <!-- MODAL de cliente (Ãºnico cliente por dia) -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="modalDate">ðŸ“…</h3>

      <div class="clients-info" id="clientsInfo"></div>

      <div class="field"><input id="clientName" placeholder="Nome do cliente (obrigatÃ³rio)"></div>
      <div class="field"><input id="clientApp" placeholder="Aplicativo (texto livre)"></div>
      <div class="field" style="display:flex;gap:8px">
        <input id="clientMac" placeholder="MAC (ex: AA:BB:CC:DD:EE:FF)" style="flex:1">
        <input id="clientKey" placeholder="KEY" style="flex:1">
      </div>
      <div class="field"><textarea id="clientNote" placeholder="ObservaÃ§Ãµes (opcional)"></textarea></div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="saveBtn" class="btn btn-save">ðŸ’¾ Salvar</button>
        <button id="closeBtn" class="btn btn-close">âœ– Fechar</button>
      </div>
    </div>
  </div>

<script>
  // STORAGE: objeto 'iptv_clients' onde cada chave Ã© 'YYYY-M-D' (m = 1..12), valor = cliente (ou undefined)
  function loadAll(){ try { return JSON.parse(localStorage.getItem('iptv_clients') || '{}'); } catch(e) { return {}; } }
  function saveAll(obj){ localStorage.setItem('iptv_clients', JSON.stringify(obj)); }

  // DOM refs
  const calendarEl = document.getElementById('calendar');
  const monthYearEl = document.getElementById('monthYear');
  const btnPrev = document.getElementById('btnPrev');
  const btnNext = document.getElementById('btnNext');
  const btnToday = document.getElementById('btnToday');
  const btnUpdate = document.getElementById('btnUpdate');

  const modalOverlay = document.getElementById('modalOverlay');
  const modalDate = document.getElementById('modalDate');
  const clientsInfo = document.getElementById('clientsInfo');
  const inputName = document.getElementById('clientName');
  const inputApp = document.getElementById('clientApp');
  const inputMac = document.getElementById('clientMac');
  const inputKey = document.getElementById('clientKey');
  const inputNote = document.getElementById('clientNote');
  const saveBtn = document.getElementById('saveBtn');
  const closeBtn = document.getElementById('closeBtn');

  // view
  let view = new Date();
  view.setDate(1);
  let selectedDate = null; // Date object for modal

  function keyFor(y,m,d){ return `${y}-${m}-${d}`; } // m: 1..12

  function renderCalendar(){
    calendarEl.innerHTML = '';
    const year = view.getFullYear();
    const month = view.getMonth(); // 0..11
    monthYearEl.textContent = new Date(year, month).toLocaleString('pt-BR', { month: 'long', year: 'numeric' }).toUpperCase();

    const firstDay = new Date(year, month, 1).getDay(); // 0..6
    const daysInMonth = new Date(year, month+1, 0).getDate();
    const today = new Date();
    const all = loadAll();

    // empty slots
    for (let i=0;i<firstDay;i++){
      const empty = document.createElement('div');
      empty.className = 'day empty';
      calendarEl.appendChild(empty);
    }

    for (let d=1; d<=daysInMonth; d++){
      const dayEl = document.createElement('div');
      dayEl.className = 'day';
      const num = document.createElement('div');
      num.className = 'num'; num.textContent = d;
      dayEl.appendChild(num);

      const k = keyFor(year, month+1, d); // month+1 -> 1..12
      if (all[k]){
        // show badge (1)
        const badge = document.createElement('div');
        badge.className = 'badge';
        badge.textContent = '1';
        dayEl.appendChild(badge);
        // dot
        const dot = document.createElement('div');
        dot.className = 'dot';
        dayEl.appendChild(dot);
      }

      if (d === today.getDate() && month === today.getMonth() && year === today.getFullYear()){
        dayEl.classList.add('today');
      }

      dayEl.addEventListener('click', () => {
        openModal(new Date(year, month, d));
      });

      calendarEl.appendChild(dayEl);
    }
  }

  function openModal(date){
    selectedDate = date;
    const y = date.getFullYear(), m = date.getMonth()+1, d = date.getDate();
    const k = keyFor(y,m,d);
    modalDate.textContent = `ðŸ“… ${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y}`;

    const all = loadAll();
    const c = all[k];
    clientsInfo.innerHTML = ''; // area that shows existing client

    if (c){
      const row = document.createElement('div');
      row.className = 'client-row';
      const info = document.createElement('div'); info.className='client-info';
      info.innerHTML = `<strong>${escapeHtml(c.name)}</strong>
                        <div style="color:#666;font-size:13px">${escapeHtml(c.app||'')}</div>
                        <div style="color:#666;font-size:12px">MAC: ${escapeHtml(c.mac||'â€”')} â€¢ KEY: ${escapeHtml(c.key||'â€”')}</div>
                        ${c.note ? `<div style="color:#666;font-size:12px">Obs: ${escapeHtml(c.note)}</div>` : ''}`;
      const actions = document.createElement('div'); actions.className='client-actions';
      const editBtn = document.createElement('button'); editBtn.className='btn'; editBtn.textContent='âœï¸';
      editBtn.title='Editar'; editBtn.style.padding='6px 8px';
      editBtn.addEventListener('click', () => {
        // fill inputs for edit
        inputName.value = c.name || '';
        inputApp.value = c.app || '';
        inputMac.value = c.mac || '';
        inputKey.value = c.key || '';
        inputNote.value = c.note || '';
        // delete existing to allow save to replace
        const allObj = loadAll(); delete allObj[k]; saveAll(allObj);
        renderCalendar();
        renderClientsInfo(); // will show nothing now
      });
      const delBtn = document.createElement('button'); delBtn.className='btn-delete'; delBtn.innerHTML='ðŸ—‘ï¸';
      delBtn.title='Apagar'; delBtn.addEventListener('click', () => {
        if (!confirm('Apagar esse cliente deste dia?')) return;
        const allObj = loadAll(); delete allObj[k]; saveAll(allObj);
        renderClientsInfo();
        renderCalendar();
      });

      actions.appendChild(editBtn); actions.appendChild(delBtn);
      row.appendChild(info); row.appendChild(actions);
      clientsInfo.appendChild(row);
    } else {
      clientsInfo.innerHTML = '<div style="color:#666">Nenhum cliente neste dia.</div>';
      inputName.value=''; inputApp.value=''; inputMac.value=''; inputKey.value=''; inputNote.value='';
    }

    modalOverlay.style.display = 'flex';
    // scroll top inside modal
    document.querySelector('.modal').scrollTop = 0;
  }

  function renderClientsInfo(){
    // re-render client info area (useful after edit/delete)
    if (!selectedDate) return;
    const y = selectedDate.getFullYear(), m = selectedDate.getMonth()+1, d = selectedDate.getDate();
    const k = keyFor(y,m,d);
    const all = loadAll();
    const c = all[k];
    clientsInfo.innerHTML = '';
    if (c){
      const row = document.createElement('div');
      row.className = 'client-row';
      const info = document.createElement('div'); info.className='client-info';
      info.innerHTML = `<strong>${escapeHtml(c.name)}</strong>
                        <div style="color:#666;font-size:13px">${escapeHtml(c.app||'')}</div>
                        <div style="color:#666;font-size:12px">MAC: ${escapeHtml(c.mac||'â€”')} â€¢ KEY: ${escapeHtml(c.key||'â€”')}</div>
                        ${c.note ? `<div style="color:#666;font-size:12px">Obs: ${escapeHtml(c.note)}</div>` : ''}`;
      const actions = document.createElement('div'); actions.className='client-actions';
      const editBtn = document.createElement('button'); editBtn.className='btn'; editBtn.textContent='âœï¸';
      editBtn.style.padding='6px 8px'; editBtn.addEventListener('click', () => {
        inputName.value = c.name || '';
        inputApp.value = c.app || '';
        inputMac.value = c.mac || '';
        inputKey.value = c.key || '';
        inputNote.value = c.note || '';
        const allObj = loadAll(); delete allObj[k]; saveAll(allObj);
        renderClientsInfo(); renderCalendar();
      });
      const delBtn = document.createElement('button'); delBtn.className='btn-delete'; delBtn.innerHTML='ðŸ—‘ï¸';
      delBtn.addEventListener('click', () => {
        if (!confirm('Apagar esse cliente deste dia?')) return;
        const allObj = loadAll(); delete allObj[k]; saveAll(allObj);
        renderClientsInfo(); renderCalendar();
      });
      actions.appendChild(editBtn); actions.appendChild(delBtn);
      row.appendChild(info); row.appendChild(actions);
      clientsInfo.appendChild(row);
    }
  }

  saveBtn.addEventListener('click', () => {
    const name = inputName.value.trim();
    const app = inputApp.value.trim();
    const mac = inputMac.value.trim();
    const key = inputKey.value.trim();
    const note = inputNote.value.trim();

    if (!name || (!mac && !key)){
      alert('Preencha pelo menos o nome e MAC ou KEY.');
      return;
    }

    const y = selectedDate.getFullYear(), m = selectedDate.getMonth()+1, d = selectedDate.getDate();
    const k = keyFor(y,m,d);
    const all = loadAll();
    all[k] = { name, app, mac, key, note, created: Date.now() };
    saveAll(all);

    renderClientsInfo();
    renderCalendar();
    // limpar inputs para prÃ³xima aÃ§Ã£o
    inputName.value=''; inputApp.value=''; inputMac.value=''; inputKey.value=''; inputNote.value='';
  });

  closeBtn.addEventListener('click', () => { modalOverlay.style.display = 'none'; });

  // keyboard ESC fecha modal
  window.addEventListener('keydown', (e) => { if (e.key === 'Escape') modalOverlay.style.display='none'; });

  // nav buttons
  btnPrev.addEventListener('click', () => { view = new Date(view.getFullYear(), view.getMonth()-1, 1); renderCalendar(); });
  btnNext.addEventListener('click', () => { view = new Date(view.getFullYear(), view.getMonth()+1, 1); renderCalendar(); });
  btnToday.addEventListener('click', () => { const t = new Date(); view = new Date(t.getFullYear(), t.getMonth(), 1); renderCalendar(); });

  btnUpdate.addEventListener('click', () => {
    if (!confirm('ForÃ§ar atualizaÃ§Ã£o do app (limpa caches e SW)?')) return;
    if ('caches' in window) caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
    if ('serviceWorker' in navigator) navigator.serviceWorker.getRegistrations().then(r => r.forEach(reg => reg.unregister()));
    setTimeout(()=>location.reload(true), 600);
  });

  // util
  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

  // initial render
  renderCalendar();

  // register service worker (relative path)
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(()=>console.log('SW registrado')).catch(e=>console.log('Erro registrando SW:', e));
  }

  /* INSTALL PROMPT: captura beforeinstallprompt (se o navegador disparar)
     Mostramos o banner nativo do sistema? O manifest que vocÃª passou usa data-uri SVG como Ã­cone;
     alguns navegadores podem nÃ£o aceitar isso para instalar. Se o botÃ£o de instalar nÃ£o aparecer,
     veja as instruÃ§Ãµes apÃ³s o HTML (na minha mensagem). */
  let deferredPrompt = null;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    // simples prompt automÃ¡tico
    if (confirm('Deseja instalar o app na tela inicial?')) {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(choice => { deferredPrompt = null; });
    }
  });

</script>
</body>
</html>